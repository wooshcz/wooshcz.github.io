<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Departure Board on Led Matrix Display | moravek.me</title>
<meta name="keywords" content="">
<meta name="description" content="Recently I saw a cool project someone shared on the ESPHome Discord server that inspired me and I&rsquo;ve decided that I&rsquo;ll attempted to replicate it and build something similar. It was a LED matrix display based departure board connected to an Arduino that was displaying publicly available information about upcoming departures of the nearest public transport stop.
Since I live in Prague where we happen to have a publicly available data where you can fetch live information about location of trams/buses/metro and their delays I thought it should be pretty much doable. The public transport APIs are available at Golemio API, you must register to get your API Key and then you&rsquo;re good to go. The default rate-limit policies are pretty generous and completely sufficient for this home project.">
<meta name="author" content="">
<link rel="canonical" href="https://moravek.me/posts/departure-board-on-led-matrix-display/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css" integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://moravek.me/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://moravek.me/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://moravek.me/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://moravek.me/apple-touch-icon.png">
<link rel="mask-icon" href="https://moravek.me/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://moravek.me/posts/departure-board-on-led-matrix-display/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://moravek.me/posts/departure-board-on-led-matrix-display/">
  <meta property="og:site_name" content="moravek.me">
  <meta property="og:title" content="Departure Board on Led Matrix Display">
  <meta property="og:description" content="Recently I saw a cool project someone shared on the ESPHome Discord server that inspired me and I’ve decided that I’ll attempted to replicate it and build something similar. It was a LED matrix display based departure board connected to an Arduino that was displaying publicly available information about upcoming departures of the nearest public transport stop.
Since I live in Prague where we happen to have a publicly available data where you can fetch live information about location of trams/buses/metro and their delays I thought it should be pretty much doable. The public transport APIs are available at Golemio API, you must register to get your API Key and then you’re good to go. The default rate-limit policies are pretty generous and completely sufficient for this home project.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-07-24T21:56:44+02:00">
    <meta property="article:modified_time" content="2025-07-24T21:56:44+02:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Departure Board on Led Matrix Display">
<meta name="twitter:description" content="Recently I saw a cool project someone shared on the ESPHome Discord server that inspired me and I&rsquo;ve decided that I&rsquo;ll attempted to replicate it and build something similar. It was a LED matrix display based departure board connected to an Arduino that was displaying publicly available information about upcoming departures of the nearest public transport stop.
Since I live in Prague where we happen to have a publicly available data where you can fetch live information about location of trams/buses/metro and their delays I thought it should be pretty much doable. The public transport APIs are available at Golemio API, you must register to get your API Key and then you&rsquo;re good to go. The default rate-limit policies are pretty generous and completely sufficient for this home project.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://moravek.me/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Departure Board on Led Matrix Display",
      "item": "https://moravek.me/posts/departure-board-on-led-matrix-display/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Departure Board on Led Matrix Display",
  "name": "Departure Board on Led Matrix Display",
  "description": "Recently I saw a cool project someone shared on the ESPHome Discord server that inspired me and I\u0026rsquo;ve decided that I\u0026rsquo;ll attempted to replicate it and build something similar. It was a LED matrix display based departure board connected to an Arduino that was displaying publicly available information about upcoming departures of the nearest public transport stop.\nSince I live in Prague where we happen to have a publicly available data where you can fetch live information about location of trams/buses/metro and their delays I thought it should be pretty much doable. The public transport APIs are available at Golemio API, you must register to get your API Key and then you\u0026rsquo;re good to go. The default rate-limit policies are pretty generous and completely sufficient for this home project.\n",
  "keywords": [
    
  ],
  "articleBody": "Recently I saw a cool project someone shared on the ESPHome Discord server that inspired me and I’ve decided that I’ll attempted to replicate it and build something similar. It was a LED matrix display based departure board connected to an Arduino that was displaying publicly available information about upcoming departures of the nearest public transport stop.\nSince I live in Prague where we happen to have a publicly available data where you can fetch live information about location of trams/buses/metro and their delays I thought it should be pretty much doable. The public transport APIs are available at Golemio API, you must register to get your API Key and then you’re good to go. The default rate-limit policies are pretty generous and completely sufficient for this home project.\nHardware 2x Waveshare RGB LED matrix display 64x32 with 2.5mm pitch. I’ve bought these over rpishop.cz. There is some documentation along with some examples on the Waveshare Wiki. ESP32 development board. I’ve this over rpishop.cz as well, but I suspect you can use almost any ESP32 board you might be having laying around. 5V/4A power supply with a 5mm barrel plug for the LCD Display is recommended. I’m using one which is rated for 3A and it is able to provide enough current for both of the panels but I suspect it’s because I run it at half brightness and also most of the pixels are off. 5V power supply with micro USB plug for the ESP32. The Waveshare LED display comes with all necessary wires plus also contains the cable which allows you to chain multiple of these displays together. In the end I’ve chained two of them so in the code you can program it like it would be one 128x32 large panel.\nHome Assistant Code I’ve decided to use Home Assistant’s RESTful integration to communicate with the Golemio API endpoint and process the raw departure data for three distinct bus stops that happen to be near me. I’m using the /v2/pid/departureboards endpoint and the following rest.yaml platform config:\n- scan_interval: 30 resource: \"https://api.golemio.cz/v2/pid/departureboards?ids[]=Uxxx\u0026ids[]=Uyyy\u0026ids[]=Uzzz\u0026minutesBefore=0\u0026minutesAfter=360\u0026includeMetroTrains=false\u0026airCondition=true\u0026skip=canceled\u0026limit=6\" headers: X-Access-Token: !secret golemio_api_key sensor: - name: Bus Departures Raw value_template: \"OK\" json_attributes: - departures This fetches the live positions and the predicted departure times for the 6 upcoming bus lines (including a real delay of each bus) that happen to stop at any of those 3 stop IDs (set in the query string in the URL resource). It extracts all objects from the departures array from the JSON string and stores it to the sensor attribute. Originally I’ve had three different sensors for three different bus stops but I’ve opted for this approach for multiple reasons but mostly because it reduces the level of duplication in HA.\nThe raw JSON response looks like this:\n{ \"stops\": [ { ... } ], \"departures\": [ { \"arrival_timestamp\": { ... }, \"delay\": { ... }, \"departure_timestamp\": { ... }, \"last_stop\": { ... }, \"route\": { ... }, \"stop\": { ... }, \"trip\": { ... } }, { ... } ], \"infotexts\": [] } Second piece to the puzzle is to parse this information and pick only the data I’m interested in displaying on the LCD: route.short_name, trip.headsign, delay.seconds and departure_timestamp.predicted. I want to display the 3 upcoming departures only (since you can’t reasonably fix more text to the display without pagination), so I’ve created a template sensor which parses the raw sensor data stored in the seteps above and save the nearest 3 departures – each in one attribute to simplify the parsing later in the ESPHome code:\n- name: \"Upcoming Bus Departures\" state: \"OK\" attributes: line1: \u003e {% set buses = state_attr('sensor.bus_departures_raw', 'departures') %} {% if buses %} {%- set bus = buses[0] %} {%- set route = bus['route']['short_name'] %} {%- set sign = bus['trip']['headsign'] or \"?\" %} {%- set delay = bus['delay']['seconds'] | default(0) %} {%- set minutes = ( (as_timestamp(bus['departure_timestamp']['predicted']) - as_timestamp(now())) / 60) | round(0, 'floor') %} {%- set line = \"{}|{}|{}|{}\".format(route, sign, delay, minutes) %} {{ line }} {% endif %} line2: \u003e ... {%- set bus = buses[1] %} ... line3: \u003e ... {%- set bus = buses[2] %} ... This results in a sensor having three attributes (line1, line2 and line3) where each is having those 4 pieces of information separated by a pipe:\nline1: 120|Na Knížecí|0|17 line2: 120|Nádraží Radotín|124|19 line3: 104|Na Hvězdárně|7|35 Now we can expose this sensor to ESPHome and try to display this text on our display.\nESPHome Configuration The display is actually not supported out of the box in ESPHome and I’ve had to use this external component. By far the biggest chunk of the code is the lambda for the display component, but after I figured out all the X and Y positions for my elements on the screen the rest was fairly straightforward. What actually ended up being the biggest challenge was picking the best font! Even with this pitch there is really only about ~10 pixels for each row and some fonts are really unusable when rendered in this size. I’ve ended up using Doto Bold.\nesphome: name: esp32-nodemcu friendly_name: esp32-nodemcu esp32: board: esp32dev framework: type: arduino external_components: - source: github://TillFleisch/ESPHome-HUB75-MatrixDisplayWrapper@main font: - file: \"gfonts://Doto@Bold\" id: mono size: 10 glyphsets: - GF_Latin_Core display: - platform: hub75_matrix_display id: matrix width: 64 height: 32 brightness: 64 chain_length: 2 G2_pin: GPIO33 C_pin: GPIO18 OE_pin: GPIO32 pages: - id: page1 lambda: |- int destPosX = 22; int delayPosX = 95; int timePosX = 127; auto red = Color(255, 0, 0); auto yellow = Color(255, 0, 255); auto orange = Color(255, 30, 150); auto green = Color(0, 50, 255); auto white = Color(255, 255, 255); auto grey = Color(150, 150, 150); std::string line1 = id(deps_line1).state; std::string line2 = id(deps_line2).state; std::string line3 = id(deps_line3).state; std::array lines = { line1, line2, line3 }; for (int i = 0; i \u003c lines.size(); ++i) { int y = i * 10; const auto \u0026line = lines[i]; std::string line_number, head_sign; float delay; int minutes; size_t start = 0; size_t end = line.find('|'); if (end != std::string::npos) { line_number = line.substr(start, end - start); start = end + 1; } end = line.find('|', start); if (end != std::string::npos) { head_sign = line.substr(start, end - start); start = end + 1; } end = line.find('|', start); if (end != std::string::npos) { delay = parse_number(line.substr(start, end - start)).value() / 60.0; start = end + 1; } minutes = parse_number(line.substr(start)).value(); // last part Color color = green; // default fallback if (delay \u003e= 9) { color = red; } else if (delay \u003e= 6) { color = orange; } else if (delay \u003e= 3) { color = yellow; } it.printf(1, y, id(mono), white, COLOR_OFF, TextAlign::TOP_LEFT, \"%s\", line_number.c_str()); it.printf(destPosX, y, id(mono), grey, COLOR_OFF, TextAlign::TOP_LEFT, \"%s\", head_sign.substr(0, 16).c_str()); it.printf(timePosX, y, id(mono), color, COLOR_OFF, TextAlign::TOP_RIGHT, \"%d\", minutes); } number: - platform: hub75_matrix_display matrix_id: matrix id: matrix_brightness name: \"Display Brightness\" switch: - platform: hub75_matrix_display matrix_id: matrix name: \"Display Power\" restore_mode: ALWAYS_ON id: power text_sensor: - platform: homeassistant id: deps_line1 entity_id: sensor.upcoming_bus_departures attribute: line1 - platform: homeassistant id: deps_line2 entity_id: sensor.upcoming_bus_departures attribute: line2 - platform: homeassistant id: deps_line3 entity_id: sensor.upcoming_bus_departures attribute: line3 Final Result As you can see in the picture it doesn’t look too bad. However I’ve decided to trim the text of the final destination for each bus because for certain names it would start to overlap with the last number - the minutes until departure. This is a bit hacky and I’ll think of improving this later.\n",
  "wordCount" : "1239",
  "inLanguage": "en",
  "datePublished": "2025-07-24T21:56:44+02:00",
  "dateModified": "2025-07-24T21:56:44+02:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://moravek.me/posts/departure-board-on-led-matrix-display/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "moravek.me",
    "logo": {
      "@type": "ImageObject",
      "url": "https://moravek.me/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://moravek.me/" accesskey="h" title="moravek.me (Alt + H)">moravek.me</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Departure Board on Led Matrix Display
    </h1>
    <div class="post-meta"><span title='2025-07-24 21:56:44 +0200 CEST'>July 24, 2025</span>

</div>
  </header> 
  <div class="post-content"><p>Recently I saw a cool project someone shared on the ESPHome Discord server that inspired me and I&rsquo;ve decided that I&rsquo;ll attempted to replicate it and build something similar. It was a LED matrix display based departure board connected to an Arduino that was displaying publicly available information about upcoming departures of the nearest public transport stop.</p>
<p>Since I live in Prague where we happen to have a publicly available data where you can fetch live information about location of trams/buses/metro and their delays I thought it should be pretty much doable. The public transport APIs are available at <a href="https://api.golemio.cz/docs/openapi/index.htm">Golemio API</a>, you must register to get your API Key and then you&rsquo;re good to go. The default rate-limit policies are pretty generous and completely sufficient for this home project.</p>
<h2 id="hardware">Hardware<a hidden class="anchor" aria-hidden="true" href="#hardware">#</a></h2>
<ul>
<li>2x Waveshare RGB LED matrix display 64x32 with 2.5mm pitch. I&rsquo;ve bought these over <a href="https://rpishop.cz/maticove-displeje/5985-waveshare-rgb-plnobarevny-led-maticovy-panel-6432-pxl-roztec-25-mm.html">rpishop.cz</a>. There is some documentation along with some examples <a href="https://www.waveshare.com/wiki/RGB-Matrix-P2.5-64x32">on the Waveshare Wiki</a>.</li>
<li>ESP32 development board. I&rsquo;ve this over <a href="https://rpishop.cz/esp32-a-esp8266/1500-esp32-vyvojova-deska.html">rpishop.cz</a> as well, but I suspect you can use almost any ESP32 board you might be having laying around.</li>
<li>5V/4A power supply with a 5mm barrel plug for the LCD Display is recommended. I&rsquo;m using one which is rated for 3A and it is able to provide enough current for both of the panels but I suspect it&rsquo;s because I run it at half brightness and also most of the pixels are off.</li>
<li>5V power supply with micro USB plug for the ESP32.</li>
</ul>
<p>The Waveshare LED display comes with all necessary wires plus also contains the cable which allows you to chain multiple of these displays together. In the end I&rsquo;ve chained two of them so in the code you can program it like it would be one 128x32 large panel.</p>
<h2 id="home-assistant-code">Home Assistant Code<a hidden class="anchor" aria-hidden="true" href="#home-assistant-code">#</a></h2>
<p>I&rsquo;ve decided to use Home Assistant&rsquo;s <a href="https://www.home-assistant.io/integrations/rest">RESTful integration</a> to communicate with the Golemio API endpoint and process the raw departure data for three distinct bus stops that happen to be near me. I&rsquo;m using the <a href="https://api.golemio.cz/pid/docs/openapi/index.htm#/%F0%9F%9A%8F%20PID%20Departure%20Boards%20(v2)/get_v2_pid_departureboards"><code>/v2/pid/departureboards</code> endpoint</a> and the following <code>rest.yaml</code> platform config:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">scan_interval</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resource</span>: <span style="color:#e6db74">&#34;https://api.golemio.cz/v2/pid/departureboards?ids[]=Uxxx&amp;ids[]=Uyyy&amp;ids[]=Uzzz&amp;minutesBefore=0&amp;minutesAfter=360&amp;includeMetroTrains=false&amp;airCondition=true&amp;skip=canceled&amp;limit=6&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">headers</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">X-Access-Token</span>: !<span style="color:#ae81ff">secret golemio_api_key</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sensor</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Bus Departures Raw</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value_template</span>: <span style="color:#e6db74">&#34;OK&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">json_attributes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">departures</span>
</span></span></code></pre></div><p>This fetches the live positions and the predicted departure times for the 6 upcoming bus lines (including a real delay of each bus) that happen to stop at any of those 3 stop IDs (set in the query string in the URL resource). It extracts all objects from the <code>departures</code> array from the JSON string and stores it to the sensor attribute. Originally I&rsquo;ve had three different sensors for three different bus stops but I&rsquo;ve opted for this approach for multiple reasons but mostly because it reduces the level of duplication in HA.</p>
<p>The raw JSON response looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;stops&#34;</span>: [
</span></span><span style="display:flex;"><span>        { <span style="color:#960050;background-color:#1e0010">...</span> }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;departures&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;arrival_timestamp&#34;</span>: { <span style="color:#960050;background-color:#1e0010">...</span> },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;delay&#34;</span>: { <span style="color:#960050;background-color:#1e0010">...</span> },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;departure_timestamp&#34;</span>: { <span style="color:#960050;background-color:#1e0010">...</span> },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;last_stop&#34;</span>: { <span style="color:#960050;background-color:#1e0010">...</span> },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;route&#34;</span>: { <span style="color:#960050;background-color:#1e0010">...</span> },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;stop&#34;</span>: { <span style="color:#960050;background-color:#1e0010">...</span> },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;trip&#34;</span>: { <span style="color:#960050;background-color:#1e0010">...</span> }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        { <span style="color:#960050;background-color:#1e0010">...</span> }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;infotexts&#34;</span>: []
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Second piece to the puzzle is to parse this information and pick only the data I&rsquo;m interested in displaying on the LCD: <code>route.short_name</code>, <code>trip.headsign</code>, <code>delay.seconds</code> and <code>departure_timestamp.predicted</code>. I want to display the 3 upcoming departures only (since you can&rsquo;t reasonably fix more text to the display without pagination), so I&rsquo;ve created a template sensor which parses the raw sensor data stored in the seteps above and save the nearest 3 departures &ndash; each in one attribute to simplify the parsing later in the ESPHome code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Upcoming Bus Departures&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#e6db74">&#34;OK&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">attributes</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">line1</span>: &gt;<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {% set buses = state_attr(&#39;sensor.bus_departures_raw&#39;, &#39;departures&#39;) %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {% if buses %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          {%- set bus = buses[0] %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            {%- set route = bus[&#39;route&#39;][&#39;short_name&#39;] %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            {%- set sign = bus[&#39;trip&#39;][&#39;headsign&#39;] or &#34;?&#34; %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            {%- set delay = bus[&#39;delay&#39;][&#39;seconds&#39;] | default(0) %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            {%- set minutes = (
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  (as_timestamp(bus[&#39;departure_timestamp&#39;][&#39;predicted&#39;]) - as_timestamp(now()))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                  / 60) | round(0, &#39;floor&#39;) %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            {%- set line = &#34;{}|{}|{}|{}&#34;.format(route, sign, delay, minutes) %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            {{ line }}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {% endif %}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">line2</span>: &gt;<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          {%- set bus = buses[1] %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">line3</span>: &gt;<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          {%- set bus = buses[2] %}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ...</span>
</span></span></code></pre></div><p>This results in a sensor having three attributes (<code>line1</code>, <code>line2</code> and <code>line3</code>) where each is having those 4 pieces of information separated by a pipe:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>line1: 120|Na Knížecí|0|17
</span></span><span style="display:flex;"><span>line2: 120|Nádraží Radotín|124|19
</span></span><span style="display:flex;"><span>line3: 104|Na Hvězdárně|7|35
</span></span></code></pre></div><p>Now we can expose this sensor to ESPHome and try to display this text on our display.</p>
<h2 id="esphome-configuration">ESPHome Configuration<a hidden class="anchor" aria-hidden="true" href="#esphome-configuration">#</a></h2>
<p>The display is actually not supported out of the box in ESPHome and I&rsquo;ve had to use <a href="https://github.com/TillFleisch/ESPHome-HUB75-MatrixDisplayWrapper">this external component</a>. By far the biggest chunk of the code is the lambda for the <code>display</code> component, but after I figured out all the X and Y positions for my elements on the screen the rest was fairly straightforward. What actually ended up being the biggest challenge was picking the best font! Even with this pitch there is really only about ~10 pixels for each row and some fonts are really unusable when rendered in this size. I&rsquo;ve ended up using Doto Bold.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">esphome</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">esp32-nodemcu</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">friendly_name</span>: <span style="color:#ae81ff">esp32-nodemcu</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">esp32</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">board</span>: <span style="color:#ae81ff">esp32dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">framework</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">arduino</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">external_components</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">source</span>: <span style="color:#ae81ff">github://TillFleisch/ESPHome-HUB75-MatrixDisplayWrapper@main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">font</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">file</span>: <span style="color:#e6db74">&#34;gfonts://Doto@Bold&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">id</span>: <span style="color:#ae81ff">mono</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">size</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">glyphsets</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">GF_Latin_Core</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">display</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">platform</span>: <span style="color:#ae81ff">hub75_matrix_display</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">id</span>: <span style="color:#ae81ff">matrix</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">width</span>: <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">height</span>: <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">brightness</span>: <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chain_length</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">G2_pin</span>: <span style="color:#ae81ff">GPIO33</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">C_pin</span>: <span style="color:#ae81ff">GPIO18</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">OE_pin</span>: <span style="color:#ae81ff">GPIO32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pages</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">id</span>: <span style="color:#ae81ff">page1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">lambda</span>: |-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          int destPosX = 22;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          int delayPosX = 95;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          int timePosX = 127;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          auto red = Color(255, 0, 0);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          auto yellow = Color(255, 0, 255);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          auto orange = Color(255, 30, 150);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          auto green = Color(0, 50, 255);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          auto white = Color(255, 255, 255);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          auto grey = Color(150, 150, 150);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          std::string line1 = id(deps_line1).state;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          std::string line2 = id(deps_line2).state;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          std::string line3 = id(deps_line3).state;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          std::array&lt;std::string, 3&gt; lines = { line1, line2, line3 };
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          for (int i = 0; i &lt; lines.size(); ++i) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            int y = i * 10;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            const auto &amp;line = lines[i];
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            std::string line_number, head_sign;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            float delay;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            int minutes;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            size_t start = 0;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            size_t end = line.find(&#39;|&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            if (end != std::string::npos) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                line_number = line.substr(start, end - start);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                start = end + 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            end = line.find(&#39;|&#39;, start);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            if (end != std::string::npos) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                head_sign = line.substr(start, end - start);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                start = end + 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            end = line.find(&#39;|&#39;, start);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            if (end != std::string::npos) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                delay = parse_number&lt;int&gt;(line.substr(start, end - start)).value() / 60.0;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                start = end + 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            minutes = parse_number&lt;int&gt;(line.substr(start)).value(); // last part
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            Color color = green;  // default fallback
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            if (delay &gt;= 9) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              color = red;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            } else if (delay &gt;= 6) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              color = orange;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            } else if (delay &gt;= 3) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              color = yellow;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            it.printf(1, y, id(mono), white, COLOR_OFF, TextAlign::TOP_LEFT, &#34;%s&#34;, line_number.c_str());
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            it.printf(destPosX, y, id(mono), grey, COLOR_OFF, TextAlign::TOP_LEFT, &#34;%s&#34;, head_sign.substr(0, 16).c_str());
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            it.printf(timePosX, y, id(mono), color, COLOR_OFF, TextAlign::TOP_RIGHT, &#34;%d&#34;, minutes);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          }</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">number</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">platform</span>: <span style="color:#ae81ff">hub75_matrix_display</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matrix_id</span>: <span style="color:#ae81ff">matrix</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">id</span>: <span style="color:#ae81ff">matrix_brightness</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Display Brightness&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">switch</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">platform</span>: <span style="color:#ae81ff">hub75_matrix_display</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matrix_id</span>: <span style="color:#ae81ff">matrix</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;Display Power&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restore_mode</span>: <span style="color:#ae81ff">ALWAYS_ON</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">id</span>: <span style="color:#ae81ff">power</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">text_sensor</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">platform</span>: <span style="color:#ae81ff">homeassistant</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">id</span>: <span style="color:#ae81ff">deps_line1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">sensor.upcoming_bus_departures</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">attribute</span>: <span style="color:#ae81ff">line1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">platform</span>: <span style="color:#ae81ff">homeassistant</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">id</span>: <span style="color:#ae81ff">deps_line2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">sensor.upcoming_bus_departures</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">attribute</span>: <span style="color:#ae81ff">line2</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">platform</span>: <span style="color:#ae81ff">homeassistant</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">id</span>: <span style="color:#ae81ff">deps_line3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">entity_id</span>: <span style="color:#ae81ff">sensor.upcoming_bus_departures</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">attribute</span>: <span style="color:#ae81ff">line3</span>
</span></span></code></pre></div><h2 id="final-result">Final Result<a hidden class="anchor" aria-hidden="true" href="#final-result">#</a></h2>
<p>As you can see in the picture it doesn&rsquo;t look too bad. However I&rsquo;ve decided to trim the text of the final destination for each bus because for certain names it would start to overlap with the last number - the minutes until departure. This is a bit hacky and I&rsquo;ll think of improving this later.</p>
<p><img alt="Matrix Display showing the upcoming departures" loading="lazy" src="/images/departure-board-matrix-display.jpg"></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://moravek.me/">moravek.me</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
